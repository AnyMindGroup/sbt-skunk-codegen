version: 2.1

.sbt_cache_key: &sbt_cache_key
                  deps-v1-{{ checksum "project/build.properties" }}-{{ checksum "build.sbt" }}-{{ checksum "project/plugins.sbt" }}

executors:

  docker:
    docker:
      - image: cimg/openjdk:17.0

  docker-test:
    docker:
      - image: cimg/openjdk:17.0
      - image: postgres:14-alpine
        environment:
          POSTGRES_PASSWORD: postgres

commands:

  store_dependencies:
    steps:
      - save_cache:
          name: Storing dependency cache
          key: *sbt_cache_key
          paths:
            - ~/.ivy2
            - ~/.sbt
            - ~/.cache/coursier

  store_build:
    steps:
      - save_cache:
          name: Storing build
          key: build-{{ .Revision }}
          paths:
            - target
            - modules/core/target
            - modules/sbt/target
            - project/target
            - project/project

  restore_build:
    steps:
      - restore_cache:
          name: Restoring build
          keys:
            - build-{{ .Revision }}

  restore_dependencies:
    steps:
      - restore_cache:
          name: Restoring dependency cache
          key: *sbt_cache_key

jobs:

  build:
    executor: docker
    steps:
      - checkout
      - restore_dependencies
      - run: sbt compile
      - store_build

  add_tag:
    executor: docker
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "14:3e:45:58:57:5a:82:40:1e:69:c5:0e:89:bf:51:50"
      - run:
          name: Configure git user
          command: |
            git config --add --global user.name "tech"
            git config --add --global user.email tech@anymindgroup.com
      - run: scripts/tag.sh

  test:
    executor: docker-test
    steps:
      - checkout
      - restore_dependencies
      - restore_build
      - run:
          name: Generate code
          command: sbt 'core/Test/runMain com.anymindgroup.RunPgCodeGen'
      - run:
          name: Test generated code
          command: sbt 'core/Test/runMain com.anymindgroup.GeneratedCodeTest'
      - store_dependencies

  test-sbt:
    executor: docker-test
    steps:
      - checkout
      - restore_dependencies
      - restore_build
      - run:
          name: Test sbt plugin
          command: sbt scripted
      - store_dependencies

  publish:
    executor: docker
    steps:
      - checkout
      - restore_dependencies
      - restore_build
      - run:
          command: sbt publish

workflows:

  pull_request:
    jobs:
      - build:
          context:
            - asia-maven.pkg.dev/anychat-staging
          filters:
            branches:
              ignore:
                - master
      - test:
          context:
            - asia-maven.pkg.dev/anychat-staging
          requires:
            - build
      - test-sbt:
          context:
            - asia-maven.pkg.dev/anychat-staging
          requires:
            - build

  integration:
    jobs:
      - build:
          context:
            - asia-maven.pkg.dev/anychat-staging
          filters:
            branches:
              only:
                - master
      - test:
          context:
            - asia-maven.pkg.dev/anychat-staging
          requires:
            - build
      - test-sbt:
          context:
            - asia-maven.pkg.dev/anychat-staging
          requires:
            - build
      - add_tag:
          requires:
            - test
            - test-sbt

  release:
    jobs:
      - publish:
          context:
            - asia-maven.pkg.dev/anychat-staging
          filters:
            tags:
              only: /v\d+\.\d+\.\d+/
            branches:
              ignore: /.*/
